{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ExtensionProvider = void 0;\n\nconst signableMessage_1 = require(\"../signableMessage\");\n\nconst signature_1 = require(\"../signature\");\n\nconst transaction_1 = require(\"../transaction\");\n\nclass ExtensionProvider {\n  constructor() {\n    this.initialized = false;\n\n    if (ExtensionProvider._instance) {\n      throw new Error(\"Error: Instantiation failed: Use ExtensionProvider.getInstance() instead of new.\");\n    }\n\n    this.account = {\n      address: \"\"\n    };\n    ExtensionProvider._instance = this;\n  }\n\n  static getInstance() {\n    return ExtensionProvider._instance;\n  }\n\n  setAddress(address) {\n    this.account.address = address;\n    return ExtensionProvider._instance;\n  }\n\n  init() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (window && window.elrondWallet) {\n        this.initialized = true;\n      }\n\n      return this.initialized;\n    });\n  }\n\n  login() {\n    let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!this.initialized) {\n        throw new Error(\"Extension provider is not initialised, call init() first\");\n      }\n\n      const {\n        token\n      } = options;\n      const data = token ? token : \"\";\n      yield this.startBgrMsgChannel(\"connect\", data);\n      return this.account.address;\n    });\n  }\n\n  logout() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!this.initialized) {\n        throw new Error(\"Extension provider is not initialised, call init() first\");\n      }\n\n      try {\n        yield this.startBgrMsgChannel(\"logout\", this.account.address);\n      } catch (error) {\n        console.warn(\"Extension origin url is already cleared!\", error);\n      }\n\n      return true;\n    });\n  }\n\n  getAddress() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!this.initialized) {\n        throw new Error(\"Extension provider is not initialised, call init() first\");\n      }\n\n      return this.account ? this.account.address : \"\";\n    });\n  }\n\n  isInitialized() {\n    return this.initialized;\n  }\n\n  isConnected() {\n    return __awaiter(this, void 0, void 0, function* () {\n      return !!this.account;\n    });\n  }\n\n  sendTransaction(transaction) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const txResponse = yield this.startBgrMsgChannel(\"sendTransactions\", {\n        from: this.account.address,\n        transactions: [transaction.toPlainObject()]\n      });\n      return transaction_1.Transaction.fromPlainObject(txResponse[0]);\n    });\n  }\n\n  signTransaction(transaction) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const txResponse = yield this.startBgrMsgChannel(\"signTransactions\", {\n        from: this.account.address,\n        transactions: [transaction.toPlainObject()]\n      });\n      return transaction_1.Transaction.fromPlainObject(txResponse[0]);\n    });\n  }\n\n  signTransactions(transactions) {\n    return __awaiter(this, void 0, void 0, function* () {\n      transactions = transactions.map(transaction => transaction.toPlainObject());\n      let txResponse = yield this.startBgrMsgChannel(\"signTransactions\", {\n        from: this.account.address,\n        transactions: transactions\n      });\n\n      try {\n        txResponse = txResponse.map(transaction => transaction_1.Transaction.fromPlainObject(transaction));\n      } catch (error) {\n        throw new Error(\"Transaction canceled.\");\n      }\n\n      return txResponse;\n    });\n  }\n\n  signMessage(message) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const data = {\n        account: this.account.address,\n        message: message.message.toString()\n      };\n      const signResponse = yield this.startBgrMsgChannel(\"signMessage\", data);\n      const signedMsg = new signableMessage_1.SignableMessage({\n        address: message.address,\n        message: Buffer.from(signResponse.message),\n        signature: new signature_1.Signature(signResponse.signature)\n      });\n      return signedMsg;\n    });\n  }\n\n  cancelAction() {\n    return this.startBgrMsgChannel(\"cancelAction\", {});\n  }\n\n  startBgrMsgChannel(operation, connectData) {\n    return new Promise(resolve => {\n      window.postMessage({\n        target: \"erdw-inpage\",\n        type: operation,\n        data: connectData\n      }, window.origin);\n\n      const eventHandler = event => {\n        if (event.isTrusted && event.data.target === \"erdw-contentScript\") {\n          if (event.data.type === \"connectResponse\") {\n            this.account = event.data.data;\n            window.removeEventListener(\"message\", eventHandler);\n            resolve(event.data.data);\n          } else {\n            window.removeEventListener(\"message\", eventHandler);\n            resolve(event.data.data);\n          }\n        }\n      };\n\n      window.addEventListener(\"message\", eventHandler, false);\n    });\n  }\n\n}\n\nexports.ExtensionProvider = ExtensionProvider;\nExtensionProvider._instance = new ExtensionProvider();","map":{"version":3,"sources":["../../src/dapp/extensionProvider.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.ExtensionProvider = void 0;\r\nconst signableMessage_1 = require(\"../signableMessage\");\r\nconst signature_1 = require(\"../signature\");\r\nconst transaction_1 = require(\"../transaction\");\r\nclass ExtensionProvider {\r\n    constructor() {\r\n        this.initialized = false;\r\n        if (ExtensionProvider._instance) {\r\n            throw new Error(\"Error: Instantiation failed: Use ExtensionProvider.getInstance() instead of new.\");\r\n        }\r\n        this.account = { address: \"\" };\r\n        ExtensionProvider._instance = this;\r\n    }\r\n    static getInstance() {\r\n        return ExtensionProvider._instance;\r\n    }\r\n    setAddress(address) {\r\n        this.account.address = address;\r\n        return ExtensionProvider._instance;\r\n    }\r\n    init() {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (window && window.elrondWallet) {\r\n                this.initialized = true;\r\n            }\r\n            return this.initialized;\r\n        });\r\n    }\r\n    login(options = {}) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.initialized) {\r\n                throw new Error(\"Extension provider is not initialised, call init() first\");\r\n            }\r\n            const { token } = options;\r\n            const data = token ? token : \"\";\r\n            yield this.startBgrMsgChannel(\"connect\", data);\r\n            return this.account.address;\r\n        });\r\n    }\r\n    logout() {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.initialized) {\r\n                throw new Error(\"Extension provider is not initialised, call init() first\");\r\n            }\r\n            try {\r\n                yield this.startBgrMsgChannel(\"logout\", this.account.address);\r\n            }\r\n            catch (error) {\r\n                console.warn(\"Extension origin url is already cleared!\", error);\r\n            }\r\n            return true;\r\n        });\r\n    }\r\n    getAddress() {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.initialized) {\r\n                throw new Error(\"Extension provider is not initialised, call init() first\");\r\n            }\r\n            return this.account ? this.account.address : \"\";\r\n        });\r\n    }\r\n    isInitialized() {\r\n        return this.initialized;\r\n    }\r\n    isConnected() {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            return !!this.account;\r\n        });\r\n    }\r\n    sendTransaction(transaction) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const txResponse = yield this.startBgrMsgChannel(\"sendTransactions\", {\r\n                from: this.account.address,\r\n                transactions: [transaction.toPlainObject()],\r\n            });\r\n            return transaction_1.Transaction.fromPlainObject(txResponse[0]);\r\n        });\r\n    }\r\n    signTransaction(transaction) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const txResponse = yield this.startBgrMsgChannel(\"signTransactions\", {\r\n                from: this.account.address,\r\n                transactions: [transaction.toPlainObject()],\r\n            });\r\n            return transaction_1.Transaction.fromPlainObject(txResponse[0]);\r\n        });\r\n    }\r\n    signTransactions(transactions) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            transactions = transactions.map((transaction) => transaction.toPlainObject());\r\n            let txResponse = yield this.startBgrMsgChannel(\"signTransactions\", {\r\n                from: this.account.address,\r\n                transactions: transactions,\r\n            });\r\n            try {\r\n                txResponse = txResponse.map((transaction) => transaction_1.Transaction.fromPlainObject(transaction));\r\n            }\r\n            catch (error) {\r\n                throw new Error(\"Transaction canceled.\");\r\n            }\r\n            return txResponse;\r\n        });\r\n    }\r\n    signMessage(message) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const data = {\r\n                account: this.account.address,\r\n                message: message.message.toString(),\r\n            };\r\n            const signResponse = yield this.startBgrMsgChannel(\"signMessage\", data);\r\n            const signedMsg = new signableMessage_1.SignableMessage({\r\n                address: message.address,\r\n                message: Buffer.from(signResponse.message),\r\n                signature: new signature_1.Signature(signResponse.signature),\r\n            });\r\n            return signedMsg;\r\n        });\r\n    }\r\n    cancelAction() {\r\n        return this.startBgrMsgChannel(\"cancelAction\", {});\r\n    }\r\n    startBgrMsgChannel(operation, connectData) {\r\n        return new Promise((resolve) => {\r\n            window.postMessage({\r\n                target: \"erdw-inpage\",\r\n                type: operation,\r\n                data: connectData,\r\n            }, window.origin);\r\n            const eventHandler = (event) => {\r\n                if (event.isTrusted && event.data.target === \"erdw-contentScript\") {\r\n                    if (event.data.type === \"connectResponse\") {\r\n                        this.account = event.data.data;\r\n                        window.removeEventListener(\"message\", eventHandler);\r\n                        resolve(event.data.data);\r\n                    }\r\n                    else {\r\n                        window.removeEventListener(\"message\", eventHandler);\r\n                        resolve(event.data.data);\r\n                    }\r\n                }\r\n            };\r\n            window.addEventListener(\"message\", eventHandler, false);\r\n        });\r\n    }\r\n}\r\nexports.ExtensionProvider = ExtensionProvider;\r\nExtensionProvider._instance = new ExtensionProvider();\r\n//# sourceMappingURL=extensionProvider.js.map"]},"metadata":{},"sourceType":"script"}